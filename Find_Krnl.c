#include <stdio.h>
#include <Windows.h>

#define MAX_FILENAME_SIZE 255

int main(int argc, char* argv[]) {

	typedef struct SYSTEM_MODULE {
		PVOID	Reserved1;
		PVOID	Reserved2;
		PVOID	ImageBaseAddress;
		ULONG	ImageSize;
		ULONG	Flags;
		USHORT	Index;
		USHORT	NameLength;
		USHORT	LoadCount;
		USHORT	PathLength;
		CHAR 	Name[MAX_FILENAME_SIZE];
	} SYSTEM_MODULE, *PSYSTEM_MODULE;

	typedef struct SYSTEM_MODULE_INFORMATION {
		ULONG   ModulesCount;
		SYSTEM_MODULE   Modules[1];
	} SYSTEM_MODULE_INFORMATION, *PSYSTEM_MODULE_INFORMATION;

	typedef enum _SYSTEM_INFORMATION_CLASS {
		SystemModuleInformation = 11,
		SystemHandleInformation = 16
	} SYSTEM_INFORMATION_CLASS;

	typedef NTSTATUS (WINAPI *PNtQuerySystemInformation)(
		SYSTEM_INFORMATION_CLASS SystemInformationClass,
		PVOID SystemInformation,
		ULONG SystemInformationLength,
		PULONG ReturnLength
	);

	ULONG retLength = 0;
	HMODULE ntdll = GetModuleHandle("ntdll");
	PNtQuerySystemInformation ntquerysysinfo = (PNtQuerySystemInformation) GetProcAddress(ntdll, "NtQuerySystemInformation");
	if (ntquerysysinfo == NULL){
		printf("GetProcAddress() failed.\n");
		return 1;
	}
	printf("[+] NTDLL is located at: 0x%p \n", ntdll);
	printf("[+] NtQuerySystemInformation is located at: 0x%p \n", ntquerysysinfo);

	ntquerysysinfo(SystemModuleInformation, NULL, 0, &retLength);

	PSYSTEM_MODULE_INFORMATION pModuleInformation = (PSYSTEM_MODULE_INFORMATION)GlobalAlloc(GMEM_ZEROINIT, retLength);

	if (pModuleInformation == NULL){
		printf("[-] Error - Could not allocate memory for module info.\n");
		return 1;
	}

	ntquerysysinfo(SystemModuleInformation, pModuleInformation, retLength, &retLength);
	printf("[+] Return length size: %d\n", retLength);
	if(retLength == 0){
		printf("[-] Error - Failed to get system information!\n");
		return 1;
	}
	printf("[+] Number of loaded modules: %d\n", pModuleInformation->ModulesCount);

    PVOID KernelBase = pModuleInformation->Modules[0].ImageBaseAddress;
    PCHAR KernelName = strrchr((PCHAR)(pModuleInformation->Modules[0].Name), '\\')+1;
    printf("[+] Module name: %s\t\n", KernelName);
    printf("[+] Base Address: 0x%p\n", KernelBase);

	return 0;
}
